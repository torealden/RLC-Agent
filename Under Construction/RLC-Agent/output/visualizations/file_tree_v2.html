<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>RLC-Agent Project Map (Enhanced)</title>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background:#0d1117;
      color:#c9d1d9;
      overflow:hidden;
    }

    .header {
      background: linear-gradient(135deg, #161b22 0%, #21262d 100%);
      padding: 12px 18px;
      border-bottom: 1px solid #30363d;
      display:flex;
      justify-content:space-between;
      align-items:center;
      position:fixed;
      top:0; left:0; right:0;
      z-index:100;
      gap:12px;
    }

    .title-wrap {
      display:flex;
      flex-direction:column;
      gap:2px;
      min-width:260px;
    }

    .header h1 {
      font-size: 16px;
      font-weight: 650;
      color: #f0f6fc;
      letter-spacing: .2px;
      line-height: 1.2;
    }

    .stats {
      font-size: 12px;
      color:#8b949e;
    }

    .header-controls {
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
      justify-content:flex-end;
    }

    .chip {
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid #30363d;
      background:#0d1117;
      color:#c9d1d9;
      font-size:12px;
      cursor:pointer;
      user-select:none;
      transition: all .18s ease;
      white-space:nowrap;
    }

    .chip:hover {
      border-color:#8b949e;
      background:#0b1220;
    }

    .chip.active {
      border-color:#58a6ff;
      box-shadow: 0 0 0 3px rgba(88,166,255,.12);
    }

    .chip .dot {
      width:10px; height:10px; border-radius:50%;
      border:2px solid #8b949e;
      background: transparent;
    }
    .chip.active .dot {
      border-color:#58a6ff;
      background:#58a6ff;
    }

    .header input {
      background: #0d1117;
      border: 1px solid #30363d;
      color: #c9d1d9;
      padding: 7px 10px;
      border-radius: 8px;
      font-size: 13px;
      width: 240px;
    }
    .header input:focus {
      outline:none;
      border-color:#58a6ff;
      box-shadow: 0 0 0 3px rgba(88,166,255,.12);
    }

    .header button {
      background: #21262d;
      border: 1px solid #30363d;
      color: #c9d1d9;
      padding: 7px 10px;
      border-radius: 8px;
      font-size: 13px;
      cursor:pointer;
      transition: all .2s ease;
    }
    .header button:hover {
      background:#30363d;
      border-color:#8b949e;
    }

    .container {
      display:flex;
      height:100vh;
      padding-top: 56px;
    }

    #tree-container {
      flex:1;
      overflow:auto;
      position:relative;
    }

    #details-panel {
      width: 380px;
      background:#161b22;
      border-left:1px solid #30363d;
      padding: 18px;
      overflow-y:auto;
    }

    #details-panel h3 {
      color:#f0f6fc;
      font-size: 13px;
      margin-bottom: 12px;
      padding-bottom: 10px;
      border-bottom: 1px solid #30363d;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }

    .kbd {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 11px;
      color:#8b949e;
      border:1px solid #30363d;
      padding:2px 6px;
      border-radius:6px;
      background:#0d1117;
      white-space:nowrap;
    }

    .detail-item { margin-bottom: 14px; }
    .detail-label {
      font-size: 11px;
      color:#8b949e;
      text-transform:uppercase;
      letter-spacing:.5px;
      margin-bottom: 4px;
    }
    .detail-value {
      font-size: 13px;
      color:#c9d1d9;
      line-height:1.45;
    }
    .detail-value.path {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 12px;
      color:#58a6ff;
      word-break: break-all;
    }

    .badges {
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      align-items:center;
    }
    .type-badge {
      display:inline-block;
      padding: 3px 8px;
      border-radius: 999px;
      font-size: 11px;
      font-weight: 600;
      letter-spacing: .2px;
    }
    .new-badge {
      background:#238636;
      color:#fff;
    }
    .layer-badge {
      background:#21262d;
      border:1px solid #30363d;
      color:#c9d1d9;
    }

    /* Tree */
    svg { width:100%; height:100%; }
    .node { cursor:pointer; }
    .node text { font-size: 12px; fill:#c9d1d9; }
    .node text.folder-name { font-weight: 650; }

    .node circle {
      stroke-width: 2px;
      transition: all .18s ease;
    }
    .node:hover circle {
      stroke-width: 3px;
      filter: brightness(1.12);
    }

    /* Semantic icon (shape fast-path) */
    .node text.icon {
      font-size: 13px;
      opacity: .95;
    }

    /* Links */
    .link {
      fill:none;
      stroke:#30363d;
      stroke-width: 1.5px;
      opacity: .9;
    }

    /* Search highlighting */
    .node.highlighted circle {
      stroke:#f0883e !important;
      stroke-width: 3px;
    }
    .node.highlighted text {
      fill:#f0883e !important;
      font-weight:650;
    }
    .node.dimmed { opacity: .18; }
    .link.dimmed { opacity: .12; }
    .link.highlighted {
      stroke:#f0883e;
      stroke-width: 2px;
      opacity: 1;
    }

    /* Layer/role styling: subtle but legible */
    .node.role-agents circle { filter: drop-shadow(0 0 6px rgba(163,113,247,.22)); }
    .node.role-orchestration circle { stroke-dasharray: 4 2; }
    .node.role-data text.label { font-style: italic; opacity: .92; }
    .node.role-output text.label { opacity: .88; }
    .node.role-db circle { filter: drop-shadow(0 0 6px rgba(88,166,255,.22)); }

    /* NEW pulse (single pulse on first paint) */
    @keyframes pulse {
      0%   { filter: drop-shadow(0 0 0 rgba(35,134,54,.0)); }
      30%  { filter: drop-shadow(0 0 10px rgba(35,134,54,.55)); }
      100% { filter: drop-shadow(0 0 0 rgba(35,134,54,.0)); }
    }
    .node.new circle {
      animation: pulse 1.8s ease-out 1;
    }

    /* Legend + mini help */
    .legend {
      position: fixed;
      bottom: 18px;
      left: 18px;
      background: rgba(22, 27, 34, 0.95);
      border: 1px solid #30363d;
      border-radius: 10px;
      padding: 12px 14px;
      font-size: 11px;
      z-index: 50;
      backdrop-filter: blur(6px);
      max-width: 420px;
    }
    .legend-title {
      font-weight: 700;
      margin-bottom: 8px;
      color:#f0f6fc;
      display:flex;
      justify-content:space-between;
      gap:10px;
      align-items:center;
    }
    .legend-grid {
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:6px 14px;
      align-items:center;
    }
    .legend-item {
      display:flex;
      align-items:center;
      gap:8px;
      margin: 2px 0;
      white-space:nowrap;
    }
    .legend-dot {
      width: 10px; height: 10px; border-radius: 50%;
    }
    .legend-note {
      margin-top:10px;
      color:#8b949e;
      line-height:1.35;
    }

    /* Architect mode column labels */
    .lane-label {
      fill:#8b949e;
      font-size: 11px;
      letter-spacing:.8px;
      text-transform:uppercase;
    }
    .lane-rect {
      fill: rgba(240,136,62,.00);
      stroke: rgba(48,54,61,.9);
      stroke-width: 1px;
      rx: 12px;
    }

    /* Mini overlay status */
    .status-toast {
      position: fixed;
      top: 66px;
      left: 18px;
      z-index: 90;
      background: rgba(13,17,23,.92);
      border:1px solid #30363d;
      border-radius: 10px;
      padding: 10px 12px;
      font-size: 12px;
      color:#c9d1d9;
      max-width: 520px;
      display:none;
      backdrop-filter: blur(6px);
    }
    .status-toast strong { color:#f0f6fc; }
  </style>
</head>
<body>
  <div class="header">
    <div class="title-wrap">
      <h1>RLC-Agent Project Map</h1>
      <span class="stats" id="stats">Loading…</span>
    </div>

    <div class="header-controls">
      <input type="text" id="search" placeholder="Search files & descriptions… (e.g. conab, scheduler, pbix)">
      <button id="expandBtn">Expand All</button>
      <button id="collapseBtn">Collapse All</button>
      <button id="resetBtn">Reset View</button>

      <div class="chip" id="traceChip" title="When enabled, clicking a node will highlight likely related modules / data / outputs.">
        <span class="dot"></span>
        Trace Mode
      </div>

      <div class="chip" id="architectChip" title="Switch to an architecture-oriented layout grouped by logical lanes.">
        <span class="dot"></span>
        Architect Mode
      </div>
    </div>
  </div>

  <div class="container">
    <div id="tree-container">
      <svg id="tree"></svg>
    </div>
    <div id="details-panel">
      <h3>
        Item Details
        <span class="kbd">Click • Shift+Click (Trace)</span>
      </h3>
      <div id="details-content">
        <p style="color:#8b949e; font-size:13px; line-height:1.4;">
          Click any item to view details. Use <b>Search</b> to jump and highlight.
          Toggle <b>Trace Mode</b> to reveal likely execution/data/report flows.
        </p>
      </div>
    </div>
  </div>

  <div class="status-toast" id="toast"></div>

  <div class="legend">
    <div class="legend-title">
      <span>Types + Roles</span>
      <span class="kbd">Mousewheel: zoom</span>
    </div>

    <div class="legend-grid">
      <div class="legend-item"><div class="legend-dot" style="background:#f0883e"></div> Folder</div>
      <div class="legend-item"><div class="legend-dot" style="background:#3fb950"></div> Python (.py)</div>
      <div class="legend-item"><div class="legend-dot" style="background:#58a6ff"></div> SQL</div>
      <div class="legend-item"><div class="legend-dot" style="background:#a371f7"></div> Markdown</div>
      <div class="legend-item"><div class="legend-dot" style="background:#f778ba"></div> Data (xlsx/csv)</div>
      <div class="legend-item"><div class="legend-dot" style="background:#79c0ff"></div> Config/JSON</div>
      <div class="legend-item"><div class="legend-dot" style="background:#8b949e"></div> Other</div>
      <div class="legend-item"><div class="legend-dot" style="background:#238636"></div> NEW/MODIFIED</div>
    </div>

    <div class="legend-note">
      <b>Roles:</b> agents glow • orchestration dashed • data italic • db glow • output slightly dim.
      <br>
      <b>Trace Mode:</b> click highlights likely connected parts of the system.
    </div>
  </div>

  <script>
    // ====== Data (as provided) ======
    const data = {
            name: "RLC-Agent",
            description: "Root project directory for RLC commodity analytics platform",
            children: [
                {
                    name: "archive",
                    description: "Archived and deprecated code for reference",
                    children: [
                        { name: "deprecated_code", description: "Deprecated scripts and modules", children: [] }
                    ]
                },
                {
                    name: "biotrack",
                    description: "BioTrack AI - Biofuel facility tracking system",
                    children: [
                        { name: "biotrack_ai.py", description: "Main AI agent for biofuel facility monitoring", type: "py" },
                        { name: "README.md", description: "BioTrack module documentation", type: "md" },
                        { name: "requirements.txt", description: "BioTrack-specific dependencies", type: "txt" },
                        {
                            name: "config",
                            description: "BioTrack configuration files",
                            children: [
                                { name: "facilities.csv", description: "Database of biofuel facilities (locations, capacity)", type: "csv" }
                            ]
                        }
                    ]
                },
                {
                    name: "config",
                    description: "Application configuration files",
                    children: [
                        { name: "credentials.env", description: "API credentials and secrets (not in git)", type: "env" },
                        { name: "credentials.example", description: "Template for credentials setup", type: "txt" },
                        { name: "DATA_SOURCES_CHECKLIST.md", description: "Checklist of data sources to implement", type: "md" },
                        { name: "data_sources_master.csv", description: "Master list of all data sources with URLs, frequencies", type: "csv" },
                        { name: "weather_cities.json", description: "Cities for weather data collection", type: "json" },
                        { name: "weather_email_config.json", description: "Weather email agent configuration", type: "json" },
                        { name: "weather_locations.json", description: "Geographic coordinates for weather stations", type: "json" }
                    ]
                },
                {
                    name: "dashboards",
                    description: "PowerBI dashboards and visualization templates",
                    children: [
                        {
                            name: "powerbi",
                            description: "PowerBI dashboard files",
                            children: [
                                { name: "First Sample Dashboard - Ethanol.pbix", description: "Ethanol market dashboard", type: "pbix" },
                                { name: "First Sample Dashboard - RLC.pbix", description: "General RLC commodity dashboard", type: "pbix" },
                                { name: "RLC_Professional_Template_Initial.pbit", description: "Reusable PowerBI template", type: "pbit" },
                                { name: "US Balance Sheets.pbix", description: "US commodity supply/demand balances", type: "pbix" },
                                { name: "us_soybean_trade_flows.pbix", description: "Soybean import/export flow visualization", type: "pbix" },
                                { name: "USDA Prices.pbix", description: "USDA price data dashboard", type: "pbix" }
                            ]
                        },
                        { name: "templates", description: "Dashboard templates", children: [] }
                    ]
                },
                {
                    name: "data",
                    description: "Data storage - raw inputs, processed outputs, exports",
                    children: [
                        { name: "cache", description: "Temporary cache for API responses", children: [] },
                        { name: "cached", description: "Persistent cached data", children: [] },
                        {
                            name: "exports",
                            description: "Exported datasets and analysis",
                            children: [
                                { name: "duplication_analysis.csv", description: "Analysis of duplicate code/data", type: "csv" },
                                { name: "HigbyBarrett_Dashboard.xlsx", description: "HB report data for dashboards", type: "xlsx" },
                                { name: "inventory_agents.csv", description: "Inventory of all agent modules", type: "csv" },
                                { name: "inventory_collectors.csv", description: "Inventory of data collectors", type: "csv" },
                                { name: "inventory_database.csv", description: "Database tables/views inventory", type: "csv" },
                                { name: "inventory_summary.csv", description: "Summary of all inventories", type: "csv" },
                                { name: "proposed_structure.csv", description: "Proposed folder restructuring", type: "csv" }
                            ]
                        },
                        {
                            name: "marketing_years",
                            description: "Marketing year analysis documents",
                            children: [
                                { name: "2012-13_corn_summary.md", description: "2012 drought year corn analysis", type: "md" },
                                { name: "2020-21_corn_summary.md", description: "2020/21 corn marketing year recap", type: "md" },
                                { name: "README.md", description: "Marketing year documentation guide", type: "md" }
                            ]
                        },
                        { name: "processed", description: "Cleaned/transformed data", children: [] },
                        {
                            name: "raw",
                            description: "Raw source data files - USDA, CONAB, EIA, trade statistics (200+ files)",
                            children: [
                                { name: "Acreage Reports (8 files)", description: "USDA planted acreage reports", type: "folder" },
                                { name: "Agricultural Prices (12 files)", description: "Monthly farm price reports", type: "folder" },
                                { name: "Attache Reports (12 files)", description: "USDA FAS international biofuel reports", type: "folder" },
                                { name: "Balance Sheets (15 files)", description: "Supply/demand balance data", type: "folder" },
                                { name: "CONAB (6 files)", description: "Brazilian crop estimates", type: "folder" },
                                { name: "Crop Production (15 files)", description: "USDA monthly crop reports", type: "folder" },
                                { name: "Crop Progress (10 files)", description: "Weekly crop condition reports", type: "folder" },
                                { name: "EIA Data (10 files)", description: "Energy Information Administration data", type: "folder" },
                                { name: "Export Inspections (8 files)", description: "Weekly grain export inspections", type: "folder" },
                                { name: "Fats and Oils (12 files)", description: "NASS fats/oils crushing reports", type: "folder" },
                                { name: "Grain Stocks (8 files)", description: "Quarterly stocks reports", type: "folder" },
                                { name: "Trade Data (40 files)", description: "Census Bureau trade statistics", type: "folder" },
                                { name: "WASDE (20 files)", description: "World supply/demand estimates", type: "folder" }
                            ]
                        },
                        {
                            name: "templates",
                            description: "Data file templates",
                            children: [
                                { name: "marketing_year_template.md", description: "Template for MY analysis docs", type: "md" }
                            ]
                        }
                    ]
                },
                {
                    name: "database",
                    description: "Database schemas, migrations, and queries",
                    children: [
                        { name: "census_trade.db", description: "SQLite database for Census trade data", type: "db" },
                        {
                            name: "migrations",
                            description: "Database migration scripts for schema evolution",
                            children: [
                                { name: "01_inventory_postgres.py", description: "Inventory existing PostgreSQL tables", type: "py" },
                                { name: "02_deploy_medallion_schema.py", description: "Deploy bronze/silver/gold layers", type: "py" },
                                { name: "03_migrate_existing_to_bronze.py", description: "Move legacy data to bronze layer", type: "py" },
                                { name: "04_migrate_sqlite_to_bronze.py", description: "Migrate SQLite data to PostgreSQL", type: "py" },
                                { name: "README.md", description: "Migration process documentation", type: "md" },
                                { name: "run_full_migration.py", description: "Run all migrations in sequence", type: "py" }
                            ]
                        },
                        {
                            name: "queries",
                            description: "Reusable SQL queries",
                            children: [
                                { name: "balance_sheet_inventory.sql", description: "Query to inventory balance sheet data", type: "sql" }
                            ]
                        },
                        {
                            name: "schemas",
                            description: "Medallion architecture schema definitions",
                            children: [
                                { name: "001_schema_foundation.sql", description: "Base schemas (bronze/silver/gold)", type: "sql" },
                                { name: "002_bronze_layer.sql", description: "Bronze (raw) layer tables", type: "sql" },
                                { name: "003_silver_layer.sql", description: "Silver (cleaned) layer tables", type: "sql" },
                                { name: "004_gold_layer.sql", description: "Gold (analytics) layer views", type: "sql" },
                                { name: "005_roles_and_security.sql", description: "Database roles and permissions", type: "sql" },
                                { name: "006_weather_schema.sql", description: "Weather observation tables", type: "sql" },
                                { name: "007_price_schema.sql", description: "Cash and futures price tables", type: "sql" },
                                { name: "008_futures_sessions_schema.sql", description: "Futures session OHLC tables", type: "sql", isNew: true },
                                { name: "010_conab_soybean.sql", description: "CONAB Brazil soybean tables", type: "sql" },
                                { name: "DATABASE_DESIGN.md", description: "Database architecture documentation", type: "md" }
                            ]
                        },
                        {
                            name: "sql",
                            description: "Additional SQL scripts",
                            children: [
                                { name: "00_init.sql", description: "Database initialization", type: "sql" },
                                { name: "002_hb_report_tables.sql", description: "HigbyBarrett report data tables", type: "sql" },
                                { name: "003_comprehensive_commodity_schema.sql", description: "Full commodity data schema", type: "sql" },
                                { name: "04_bronze_wasde.sql", description: "WASDE bronze layer", type: "sql" },
                                { name: "05_silver_observation.sql", description: "Silver observation tables", type: "sql" },
                                { name: "06_gold_views.sql", description: "Gold analytics views", type: "sql" }
                            ]
                        },
                        {
                            name: "views",
                            description: "Database views",
                            children: [
                                { name: "01_traditional_balance_sheets.sql", description: "Balance sheet views v1", type: "sql" },
                                { name: "02_traditional_balance_sheets_v2.sql", description: "Balance sheet views v2", type: "sql" },
                                { name: "03_trade_flow_views.sql", description: "Import/export flow views", type: "sql" },
                                { name: "04_ers_gold_views.sql", description: "ERS data gold layer views", type: "sql" }
                            ]
                        }
                    ]
                },
                {
                    name: "docs",
                    description: "Project documentation (80+ files)",
                    children: [
                        { name: "ARCHITECTURE_PLAN.md", description: "System architecture overview", type: "md" },
                        { name: "AUTOMATED_DATA_PIPELINE.md", description: "Data pipeline documentation", type: "md" },
                        { name: "BALANCE_SHEET_KNOWLEDGE.md", description: "Balance sheet methodology", type: "md" },
                        { name: "CODE_REVIEW.md", description: "Code review guidelines", type: "md" },
                        { name: "CREDENTIALS_REQUIRED.md", description: "Required API credentials list", type: "md" },
                        { name: "DATA_SOURCE_REGISTRY.md", description: "Registry of all data sources", type: "md" },
                        { name: "FILE_INVENTORY_ANNOTATED.md", description: "Complete annotated file listing", type: "md" },
                        { name: "HB_REPORT_AUTOMATION_GUIDE.md", description: "HigbyBarrett report automation", type: "md" },
                        { name: "INTEGRATION_GUIDE.md", description: "System integration guide", type: "md" },
                        { name: "LLM_TRAINING_STRATEGY.md", description: "LLM fine-tuning strategy", type: "md" },
                        { name: "POWER_BI_SETUP_GUIDE.md", description: "PowerBI configuration", type: "md" },
                        { name: "Agents 101.docx", description: "Introduction to agent architecture", type: "docx" },
                        { name: "Complete RLC Master Agent Setup Guide.docx", description: "Full setup instructions", type: "docx" },
                        { name: "Master-Agent Architecture.docx", description: "Architecture iterations", type: "docx" },
                        { name: "RLC Tech Stack.docx", description: "Technology stack overview", type: "docx" },
                        {
                            name: "architecture",
                            description: "Architecture documents",
                            children: [
                                { name: "Folder Structure - The Bible.docx", description: "Definitive folder structure", type: "docx" },
                                { name: "LIBRARY_STRUCTURE.md", description: "Code library organization", type: "md" }
                            ]
                        },
                        {
                            name: "training",
                            description: "Training materials",
                            children: [
                                { name: "CC_TRAINING_GUIDE.md", description: "Claude Code training guide", type: "md" }
                            ]
                        }
                    ]
                },
                {
                    name: "domain_knowledge",
                    description: "Reference materials for LLM context and analyst training",
                    children: [
                        {
                            name: "balance_sheets",
                            description: "Balance sheet templates by commodity category",
                            children: [
                                { name: "biofuels", description: "Ethanol, biodiesel S&D templates", children: [] },
                                { name: "fats_greases", description: "Animal fats, vegetable oils", children: [] },
                                { name: "feed_grains", description: "Corn, sorghum, barley, oats", children: [] },
                                { name: "food_grains", description: "Wheat, rice", children: [] },
                                { name: "oilseeds", description: "Soybeans, canola, sunflower", children: [] }
                            ]
                        },
                        {
                            name: "crop_calendars",
                            description: "Monthly crop activity calendars (12 GIF files)",
                            children: [
                                { name: "January.gif", description: "January planting/harvest calendar", type: "gif" },
                                { name: "February.gif", description: "February calendar", type: "gif" },
                                { name: "March.gif", description: "March calendar", type: "gif" },
                                { name: "April.gif", description: "April calendar", type: "gif" },
                                { name: "May.gif", description: "May calendar", type: "gif" },
                                { name: "June.gif", description: "June calendar", type: "gif" },
                                { name: "July.gif", description: "July calendar", type: "gif" },
                                { name: "August.gif", description: "August calendar", type: "gif" },
                                { name: "September.gif", description: "September calendar", type: "gif" },
                                { name: "October.gif", description: "October calendar", type: "gif" },
                                { name: "November.gif", description: "November calendar", type: "gif" },
                                { name: "December.gif", description: "December calendar", type: "gif" }
                            ]
                        },
                        {
                            name: "crop_maps",
                            description: "Production area maps by region",
                            children: [
                                { name: "argentina", description: "Argentina production maps", children: [] },
                                {
                                    name: "brazil",
                                    description: "Brazil production maps",
                                    children: [
                                        { name: "Brazil - Soybean - 2023.png", description: "Brazil soybean production areas", type: "png" }
                                    ]
                                },
                                {
                                    name: "us",
                                    description: "US production maps (17 PNGs)",
                                    children: [
                                        { name: "US - Corn - 2023.png", description: "US corn production areas", type: "png" },
                                        { name: "US - Soybean - 2023.png", description: "US soybean production areas", type: "png" },
                                        { name: "US - Wheat - 2023.png", description: "US wheat production areas", type: "png" },
                                        { name: "US - Cotton - 2023.png", description: "US cotton production areas", type: "png" },
                                        { name: "US - Sorghum - 2023.png", description: "US sorghum production areas", type: "png" }
                                    ]
                                }
                            ]
                        },
                        {
                            name: "operator_guides",
                            description: "Operational procedures for different agent roles",
                            children: [
                                { name: "App Developer Operator.docx", description: "App development procedures", type: "docx" },
                                { name: "Checker Operator.docx", description: "Quality check procedures", type: "docx" },
                                { name: "Data Gathering Operator.docx", description: "Data collection procedures", type: "docx" },
                                { name: "Pattern Analysis Operator.docx", description: "Pattern analysis procedures", type: "docx" },
                                { name: "Project Manager Operator.docx", description: "PM procedures", type: "docx" },
                                { name: "Trading Code Operator.docx", description: "Trading algorithm procedures", type: "docx" }
                            ]
                        },
                        {
                            name: "sample_presentations",
                            description: "Historical presentation files",
                            children: [
                                { name: "AFOA Conference Presentation.pptx", description: "AFOA 2021 presentation", type: "pptx" },
                                { name: "Biomass Based Diesel Outlook.pptx", description: "BBD outlook", type: "pptx" },
                                { name: "Feed Grains Presentation.pptx", description: "Feed grains overview", type: "pptx" },
                                { name: "Master Presentation.pptx", description: "Master template", type: "pptx" }
                            ]
                        },
                        {
                            name: "sample_reports",
                            description: "Sample industry reports for training",
                            children: [
                                { name: "HigbyBarrett Weekly Report samples (6)", description: "HB weekly report samples", type: "docx" },
                                {
                                    name: "data",
                                    description: "Report source data",
                                    children: [
                                        { name: "cross_commodity (11 files)", description: "Multi-commodity reports", type: "folder" },
                                        { name: "feed_grains (4 files)", description: "Feed grain data", type: "folder" },
                                        { name: "food_grains (15 CSVs)", description: "Wheat yearbook tables", type: "folder" },
                                        { name: "livestock (11 files)", description: "Cattle on feed data", type: "folder" }
                                    ]
                                }
                            ]
                        },
                        {
                            name: "special_situations",
                            description: "Analysis of historical market-moving events",
                            children: [
                                { name: "2012_us_drought.md", description: "2012 US drought impact analysis", type: "md" },
                                { name: "2018_china_trade_war.md", description: "China trade war market impact", type: "md" },
                                { name: "2020_china_demand_surge.md", description: "2020 China buying surge", type: "md" },
                                { name: "2020_derecho.md", description: "August 2020 derecho damage", type: "md" },
                                { name: "2022_ukraine_war.md", description: "Ukraine war grain impact", type: "md" },
                                { name: "README.md", description: "Special situations guide", type: "md" }
                            ]
                        }
                    ]
                },
                {
                    name: "output",
                    description: "Generated outputs - logs, reports, visualizations",
                    children: [
                        {
                            name: "logs",
                            description: "System and process logs",
                            children: [
                                { name: "data_checker.log", description: "Data validation agent log", type: "log" },
                                { name: "hb_report_v2.log", description: "HB report V2 generation logs", type: "log" },
                                { name: "overnight_runner_20260127.log", description: "Overnight daemon log", type: "log", isNew: true },
                                { name: "weather_collector.log", description: "Weather collection log", type: "log" }
                            ]
                        },
                        {
                            name: "reports",
                            description: "Generated market reports",
                            children: [
                                { name: "brazil_crop_update", description: "Brazil crop updates", children: [] },
                                {
                                    name: "higby_barrett",
                                    description: "HigbyBarrett weekly reports",
                                    children: [
                                        { name: "HB_Weekly_DATA_V2.json", description: "Report source data JSON", type: "json" },
                                        { name: "HB_Weekly_PROMPT_V2.txt", description: "LLM prompts used", type: "txt" },
                                        { name: "HB_Weekly_Report_V2.md", description: "Generated report markdown", type: "md" }
                                    ]
                                },
                                {
                                    name: "weather_summaries",
                                    description: "Weather summary reports (12 files)",
                                    children: [
                                        { name: "weather_summary_*.txt", description: "Daily weather summaries", type: "txt" }
                                    ]
                                }
                            ]
                        },
                        {
                            name: "visualizations",
                            description: "Generated charts and graphs",
                            children: [
                                { name: "corn_balance_sheet.png", description: "Corn S&D chart", type: "png" },
                                { name: "corn_prices.png", description: "Corn price chart", type: "png" },
                                { name: "soybean_balance_sheet.png", description: "Soybean S&D chart", type: "png" },
                                { name: "soybean_crush_margin.png", description: "Crush margin chart", type: "png" },
                                { name: "wheat_balance_sheet.png", description: "Wheat S&D chart", type: "png" },
                                { name: "wheat_export_destinations.png", description: "Wheat export flows", type: "png" },
                                { name: "file_tree.html", description: "This visualization", type: "html" },
                                { name: "file_treemap.html", description: "Treemap visualization", type: "html" }
                            ]
                        }
                    ]
                },
                {
                    name: "scripts",
                    description: "Utility scripts for data collection, transformation, and analysis",
                    children: [
                        { name: "collect.py", description: "General data collection runner", type: "py" },
                        { name: "create_powerbi_export.py", description: "Export data for PowerBI", type: "py" },
                        { name: "data_scheduler.py", description: "Data collection scheduler", type: "py" },
                        { name: "ingest_wasde.py", description: "WASDE report ingestion", type: "py" },
                        { name: "ingest_wheat_data.py", description: "Wheat data ingestion", type: "py" },
                        { name: "llm_assistant.py", description: "LLM assistant interface", type: "py" },
                        { name: "overnight_runner.py", description: "Overnight scheduler daemon", type: "py", isNew: true },
                        { name: "pull_census_trade.py", description: "Census trade data pull", type: "py" },
                        { name: "pull_weekly_inspections.py", description: "Weekly export inspections", type: "py" },
                        { name: "test_hb_report_generation_v2.py", description: "HB report test V2 (enhanced)", type: "py" },
                        {
                            name: "collectors",
                            description: "Standalone collector scripts",
                            children: [
                                { name: "__init__.py", description: "Package init", type: "py" },
                                { name: "ers_feed_grains_collector.py", description: "ERS feed grains collector", type: "py" },
                                { name: "ers_monthly_outlook_collector.py", description: "ERS outlook collector", type: "py" }
                            ]
                        },
                        {
                            name: "deployment",
                            description: "Deployment and setup scripts",
                            children: [
                                { name: "agent_tools.py", description: "Agent utility functions", type: "py" },
                                { name: "balance_sheet_extractor.py", description: "Balance sheet data extraction", type: "py" },
                                { name: "db_config.py", description: "Database configuration", type: "py" },
                                { name: "deploy_to_rlc_server.py", description: "Server deployment script", type: "py" },
                                { name: "document_rag.py", description: "Document RAG system", type: "py" },
                                { name: "forecast_tracker.py", description: "Forecast accuracy tracker", type: "py" },
                                { name: "powerbi_export.py", description: "PowerBI data export", type: "py" },
                                { name: "setup_rlc_server.ps1", description: "PowerShell server setup", type: "ps1" }
                            ]
                        },
                        {
                            name: "transformations",
                            description: "Data transformation (bronze -> silver -> gold)",
                            children: [
                                { name: "__init__.py", description: "Package init", type: "py" },
                                { name: "oilseed_silver_transformations.py", description: "Oilseed data transforms", type: "py" },
                                { name: "silver_transformations.py", description: "General silver transforms", type: "py" },
                                { name: "wheat_silver_transformations.py", description: "Wheat data transforms", type: "py" }
                            ]
                        },
                        {
                            name: "visualizations",
                            description: "Chart generation scripts",
                            children: [
                                { name: "__init__.py", description: "Package init", type: "py" },
                                { name: "gold_visualizations.py", description: "Gold layer visualizations", type: "py" },
                                { name: "oilseed_visualizations.py", description: "Oilseed charts", type: "py" },
                                { name: "wheat_visualizations.py", description: "Wheat charts", type: "py" }
                            ]
                        }
                    ]
                },
                {
                    name: "src",
                    description: "Main source code - agents, services, orchestrators",
                    children: [
                        { name: "__init__.py", description: "Package init", type: "py" },
                        { name: "main.py", description: "Application entry point", type: "py" },
                        {
                            name: "agents",
                            description: "AI agents for data collection, analysis, and reporting",
                            children: [
                                { name: "__init__.py", description: "Package init", type: "py" },
                                {
                                    name: "analysis",
                                    description: "Market analysis agents",
                                    children: [
                                        { name: "__init__.py", description: "Package init", type: "py" },
                                        { name: "fundamental_analyzer.py", description: "Fundamental S&D analysis", type: "py" },
                                        { name: "price_forecaster.py", description: "Price prediction agent", type: "py" },
                                        { name: "spread_and_basis_analyzer.py", description: "Spread/basis analysis", type: "py" }
                                    ]
                                },
                                {
                                    name: "base",
                                    description: "Base classes for all agents",
                                    children: [
                                        { name: "__init__.py", description: "Package init", type: "py" },
                                        { name: "base_collector.py", description: "Base data collector class", type: "py" },
                                        { name: "base_lineup_agent.py", description: "Base vessel lineup agent", type: "py" },
                                        { name: "base_trade_agent.py", description: "Base trade data agent", type: "py" }
                                    ]
                                },
                                {
                                    name: "collectors",
                                    description: "Data collection agents by region/source",
                                    children: [
                                        { name: "__init__.py", description: "Package init", type: "py" },
                                        {
                                            name: "asia",
                                            description: "Asian data collectors",
                                            children: [
                                                { name: "__init__.py", description: "Package init", type: "py" },
                                                { name: "mpob_collector.py", description: "Malaysia Palm Oil Board data", type: "py" }
                                            ]
                                        },
                                        {
                                            name: "canada",
                                            description: "Canadian data collectors",
                                            children: [
                                                { name: "__init__.py", description: "Package init", type: "py" },
                                                { name: "canada_cgc_collector.py", description: "Canadian Grain Commission data", type: "py" },
                                                { name: "canada_statscan_collector.py", description: "Statistics Canada data", type: "py" }
                                            ]
                                        },
                                        {
                                            name: "europe",
                                            description: "European data collectors",
                                            children: [
                                                { name: "__init__.py", description: "Package init", type: "py" }
                                            ]
                                        },
                                        {
                                            name: "global",
                                            description: "Global data collectors",
                                            children: [
                                                { name: "__init__.py", description: "Package init", type: "py" },
                                                { name: "faostat_collector.py", description: "FAO statistics collector", type: "py" }
                                            ]
                                        },
                                        {
                                            name: "market",
                                            description: "Market data collectors (prices, futures)",
                                            children: [
                                                { name: "__init__.py", description: "Package init", type: "py" },
                                                { name: "cme_settlements_collector.py", description: "CME settlement prices", type: "py" },
                                                { name: "futures_data_collector.py", description: "General futures data", type: "py" },
                                                { name: "ibkr_collector.py", description: "Interactive Brokers data", type: "py" },
                                                { name: "tradestation_collector.py", description: "TradeStation data", type: "py" },
                                                { name: "yahoo_futures_collector.py", description: "Yahoo Finance futures with session capture", type: "py", isNew: true }
                                            ]
                                        },
                                        {
                                            name: "south_america",
                                            description: "South American data collectors",
                                            children: [
                                                { name: "__init__.py", description: "Package init", type: "py" },
                                                { name: "abiove_collector.py", description: "Brazil Veg Oil Association data", type: "py" },
                                                { name: "argentina_agent.py", description: "Argentina trade data", type: "py" },
                                                { name: "base_collector.py", description: "Base collector for SA", type: "py", isNew: true },
                                                { name: "brazil_agent.py", description: "Brazil Comex Stat trade data", type: "py" },
                                                { name: "brazil_lineup_agent.py", description: "Brazil vessel lineup", type: "py" },
                                                { name: "conab_collector.py", description: "CONAB Brazil crop estimates", type: "py", isNew: true },
                                                { name: "conab_soybean_agent.py", description: "CONAB soybean specialist", type: "py" },
                                                { name: "ibge_sidra_collector.py", description: "Brazil IBGE statistics", type: "py" },
                                                { name: "imea_collector.py", description: "Mato Grosso economics institute", type: "py" },
                                                { name: "magyp_collector.py", description: "Argentina agriculture ministry", type: "py" }
                                            ]
                                        },
                                        {
                                            name: "tenders",
                                            description: "Tender monitoring agents",
                                            children: [
                                                { name: "__init__.py", description: "Package init", type: "py" },
                                                { name: "alert_system.py", description: "Tender alert notifications", type: "py" },
                                                { name: "wheat_tender_collector.py", description: "International wheat tenders", type: "py" }
                                            ]
                                        },
                                        {
                                            name: "us",
                                            description: "US government data collectors",
                                            children: [
                                                { name: "__init__.py", description: "Package init", type: "py" },
                                                { name: "base_collector.py", description: "Base US collector", type: "py" },
                                                { name: "census_trade_collector.py", description: "Census Bureau trade data", type: "py" },
                                                { name: "cftc_cot_collector.py", description: "CFTC Commitments of Traders", type: "py" },
                                                { name: "drought_collector.py", description: "US Drought Monitor data", type: "py" },
                                                { name: "eia_ethanol_collector.py", description: "EIA ethanol production", type: "py" },
                                                { name: "eia_petroleum_collector.py", description: "EIA petroleum data", type: "py" },
                                                { name: "epa_rfs_collector.py", description: "EPA Renewable Fuel Standard", type: "py" },
                                                { name: "usda_ams_collector.py", description: "USDA AMS market news", type: "py" },
                                                { name: "usda_ers_collector.py", description: "USDA ERS outlook data", type: "py" },
                                                { name: "usda_fas_collector.py", description: "USDA FAS export sales", type: "py" },
                                                { name: "usda_nass_collector.py", description: "USDA NASS crop data", type: "py" }
                                            ]
                                        }
                                    ]
                                },
                                {
                                    name: "core",
                                    description: "Core agent infrastructure",
                                    children: [
                                        { name: "__init__.py", description: "Package init", type: "py" },
                                        { name: "approval_manager.py", description: "Human approval workflow", type: "py" },
                                        { name: "data_agent.py", description: "Data handling agent", type: "py" },
                                        { name: "database_agent.py", description: "Database operations agent", type: "py" },
                                        { name: "master_agent.py", description: "Master orchestration agent", type: "py" },
                                        { name: "memory_manager.py", description: "Agent memory/context manager", type: "py" },
                                        { name: "transformation_logger.py", description: "ETL audit logger", type: "py" },
                                        { name: "verification_agent.py", description: "Data verification agent", type: "py" }
                                    ]
                                },
                                {
                                    name: "integration",
                                    description: "External system integrations",
                                    children: [
                                        { name: "__init__.py", description: "Package init", type: "py" },
                                        { name: "calendar_agent.py", description: "Google Calendar integration", type: "py" },
                                        { name: "email_agent.py", description: "Email processing agent", type: "py" },
                                        { name: "ibkr_api_connector.py", description: "IBKR API connection", type: "py" },
                                        { name: "notion_manager.py", description: "Notion workspace integration", type: "py" }
                                    ]
                                },
                                {
                                    name: "reporting",
                                    description: "Report generation agents",
                                    children: [
                                        { name: "__init__.py", description: "Package init", type: "py" },
                                        { name: "internal_data_agent.py", description: "Internal data reports", type: "py" },
                                        { name: "market_research_agent.py", description: "Market research agent", type: "py" },
                                        { name: "price_data_agent.py", description: "Price data reports", type: "py" },
                                        { name: "report_writer_agent.py", description: "Report generation agent", type: "py" }
                                    ]
                                },
                                {
                                    name: "standalone",
                                    description: "Standalone agent runner system",
                                    children: [
                                        { name: "__init__.py", description: "Package init", type: "py" },
                                        { name: "agent.py", description: "Standalone agent class", type: "py" },
                                        { name: "config.py", description: "Standalone configuration", type: "py" },
                                        { name: "run_daemon.bat", description: "Windows daemon runner", type: "bat" },
                                        { name: "start_agent.bat", description: "Windows agent starter", type: "bat" },
                                        { name: "submit_task.py", description: "Task submission script", type: "py" },
                                        { name: "tools.py", description: "Standalone agent tools", type: "py" }
                                    ]
                                }
                            ]
                        },
                        {
                            name: "orchestrators",
                            description: "Pipeline orchestration for multi-step workflows",
                            children: [
                                { name: "__init__.py", description: "Package init", type: "py" },
                                { name: "conab_soybean_orchestrator.py", description: "CONAB soybean data pipeline", type: "py" },
                                { name: "hb_report_orchestrator.py", description: "HB report generation pipeline", type: "py" },
                                { name: "pipeline_orchestrator.py", description: "General pipeline orchestrator", type: "py" },
                                { name: "trade_data_orchestrator.py", description: "Trade data pipeline", type: "py" }
                            ]
                        },
                        {
                            name: "scheduler",
                            description: "Task scheduling and automation",
                            children: [
                                { name: "__init__.py", description: "Package init", type: "py" },
                                { name: "agent_scheduler.py", description: "Agent execution scheduler", type: "py" },
                                { name: "daily_activity_log.py", description: "Daily activity logging", type: "py" },
                                { name: "master_scheduler.py", description: "Master schedule with futures + CONAB", type: "py", isNew: true },
                                { name: "README.md", description: "Scheduler documentation", type: "md" },
                                { name: "report_scheduler.py", description: "Report generation scheduler", type: "py" },
                                { name: "trade_scheduler.py", description: "Trade data scheduler", type: "py" },
                                {
                                    name: "agents",
                                    description: "Scheduler-specific agents",
                                    children: [
                                        { name: "cash_price_collector_agent.py", description: "Cash price collection", type: "py" },
                                        { name: "data_checker_agent.py", description: "Data validation agent", type: "py" },
                                        { name: "weather_collector_agent.py", description: "Weather data collection", type: "py" },
                                        { name: "weather_email_agent.py", description: "Weather email processing", type: "py" }
                                    ]
                                },
                                {
                                    name: "tasks",
                                    description: "Windows Task Scheduler scripts",
                                    children: [
                                        { name: "README.md", description: "Task documentation", type: "md" },
                                        { name: "run_agent_scheduler.bat", description: "Run agent scheduler", type: "bat" },
                                        { name: "run_data_checker.bat", description: "Run data checker", type: "bat" },
                                        { name: "run_weather_collector.bat", description: "Run weather collector", type: "bat" },
                                        { name: "setup_windows_tasks.ps1", description: "PowerShell task setup", type: "ps1" }
                                    ]
                                }
                            ]
                        },
                        {
                            name: "services",
                            description: "Shared service modules",
                            children: [
                                { name: "__init__.py", description: "Package init", type: "py" },
                                { name: "city_enrollment_service.py", description: "City/location enrollment", type: "py" },
                                { name: "location_service.py", description: "Geographic location service", type: "py" },
                                {
                                    name: "api",
                                    description: "API client services",
                                    children: [
                                        { name: "__init__.py", description: "Package init", type: "py" },
                                        { name: "census_api.py", description: "Census Bureau API client", type: "py" },
                                        { name: "usda_api.py", description: "USDA API client", type: "py" },
                                        { name: "weather_api.py", description: "OpenWeather API client", type: "py" },
                                        { name: "world_weather_service.py", description: "World weather service", type: "py" }
                                    ]
                                },
                                {
                                    name: "database",
                                    description: "Database services",
                                    children: [
                                        { name: "__init__.py", description: "Package init", type: "py" },
                                        { name: "data_loader.py", description: "Data loading utilities", type: "py" },
                                        { name: "db_config.py", description: "Database configuration", type: "py" },
                                        { name: "schema.py", description: "Schema definitions", type: "py" }
                                    ]
                                },
                                {
                                    name: "document",
                                    description: "Document processing services",
                                    children: [
                                        { name: "__init__.py", description: "Package init", type: "py" },
                                        { name: "document_builder.py", description: "Document generation", type: "py" },
                                        { name: "document_rag.py", description: "Document RAG system", type: "py" }
                                    ]
                                }
                            ]
                        },
                        {
                            name: "tools",
                            description: "Shared agent tools",
                            children: [
                                { name: "__init__.py", description: "Package init", type: "py" },
                                { name: "agent_tools.py", description: "Common agent utilities", type: "py" }
                            ]
                        },
                        {
                            name: "utils",
                            description: "Utility functions",
                            children: [
                                { name: "__init__.py", description: "Package init", type: "py" },
                                { name: "config.py", description: "Configuration utilities", type: "py" }
                            ]
                        }
                    ]
                },
                {
                    name: "tests",
                    description: "Test files and fixtures",
                    children: [
                        { name: "test_conab_soybean_pipeline.py", description: "CONAB pipeline tests", type: "py" },
                        { name: "test_wheat_tender_collector.py", description: "Wheat tender tests", type: "py" },
                        {
                            name: "collectors",
                            description: "Collector test fixtures",
                            children: [
                                { name: "test_sample_food_sales.csv", description: "Test data file", type: "csv" }
                            ]
                        }
                    ]
                },
                {
                    name: "training",
                    description: "LLM training materials",
                    children: [
                        { name: "CC_TRAINING_GUIDE.md", description: "Claude Code training guide", type: "md" },
                        {
                            name: "process_docs",
                            description: "Process documentation",
                            children: [
                                { name: "TEMPLATE_process.md", description: "Process document template", type: "md" }
                            ]
                        }
                    ]
                },
                // Root files
                { name: ".env", description: "Environment variables (DB credentials, API keys)", type: "env" },
                { name: ".env.example", description: "Template for environment variables", type: "txt" },
                { name: ".gitignore", description: "Git ignore patterns", type: "txt" },
                { name: ".mcp.json", description: "Model Context Protocol config for Claude Code", type: "json" },
                { name: "LLM_SETUP_PLAN.md", description: "Planning document for local LLM integration", type: "md" },
                { name: "README.md", description: "Project overview and setup instructions", type: "md" },
                { name: "requirements.txt", description: "Python package dependencies", type: "txt" },
                { name: "start_overnight_test.py", description: "Launch overnight data collection tests", type: "py" }
            ]
        };

    // ====== Colors (as provided) ======
    const typeColors = {
            'py': '#3fb950',
            'sql': '#58a6ff',
            'md': '#a371f7',
            'xlsx': '#f778ba',
            'csv': '#f778ba',
            'xls': '#f778ba',
            'docx': '#8b949e',
            'doc': '#8b949e',
            'pdf': '#8b949e',
            'pptx': '#8b949e',
            'json': '#79c0ff',
            'env': '#79c0ff',
            'txt': '#8b949e',
            'bat': '#79c0ff',
            'ps1': '#79c0ff',
            'sh': '#79c0ff',
            'png': '#fdcb6e',
            'gif': '#fdcb6e',
            'jpg': '#fdcb6e',
            'pbix': '#f39c12',
            'pbit': '#f39c12',
            'db': '#e17055',
            'log': '#636e72',
            'html': '#e84393',
            'folder': '#f0883e'
        };

    // ====== State ======
    let traceMode = false;
    let architectMode = false;
    let lastClicked = null;

    // ====== Helpers ======
    function isFolder(d) {
      return !!(d.children || d._children);
    }

    function extOf(d) {
      if (d.data.type) return String(d.data.type).toLowerCase();
      const n = (d.data.name || "");
      if (n.includes(".")) return n.split(".").pop().toLowerCase();
      return isFolder(d) ? "folder" : "other";
    }

    function truncate(s, max=42) {
      s = String(s || "");
      return s.length > max ? (s.slice(0, max-3) + "...") : s;
    }

    function getNodeColor(d) {
      if (d.data.isNew) return '#238636';
      if (isFolder(d)) return typeColors.folder || '#f0883e';
      const ext = extOf(d);
      return typeColors[ext] || '#8b949e';
    }

    function buildPath(d) {
      return d.ancestors().reverse().map(n => n.data.name).join('/');
    }

    // Logical layer classification from path prefix
    function getLayer(pathLower) {
      // strongest, most specific first
      if (pathLower.includes("/src/agents/")) return "Agents";
      if (pathLower.includes("/src/orchestrators/") || pathLower.includes("/orchestrators/")) return "Orchestration";
      if (pathLower.includes("/src/scheduler/") || pathLower.includes("/scheduler/") || pathLower.includes("overnight")) return "Scheduling";
      if (pathLower.includes("/database/")) return "Database";
      if (pathLower.includes("/data/")) return "Data";
      if (pathLower.includes("/output/")) return "Output";
      if (pathLower.includes("/docs/") || pathLower.endsWith(".md") || pathLower.endsWith(".docx")) return "Docs";
      if (pathLower.includes("/scripts/")) return "Scripts";
      if (pathLower.includes("/config/") || pathLower.includes(".env")) return "Config";
      return "Other";
    }

    function getRoleClass(layer) {
      switch(layer) {
        case "Agents": return "role-agents";
        case "Orchestration": return "role-orchestration";
        case "Scheduling": return "role-orchestration";
        case "Database": return "role-db";
        case "Data": return "role-data";
        case "Output": return "role-output";
        default: return "";
      }
    }

    function getIcon(d, pathLower) {
      // Role-based icons beat extension-based icons
      if (isFolder(d)) return "📁";
      const ext = extOf(d);
      if (pathLower.includes("/src/agents/") || (d.data.name||"").toLowerCase().includes("agent")) return "🤖";
      if (pathLower.includes("/orchestrator") || (d.data.name||"").toLowerCase().includes("orchestrator")) return "🧭";
      if (pathLower.includes("/scheduler") || (d.data.name||"").toLowerCase().includes("scheduler") || (d.data.name||"").toLowerCase().includes("overnight")) return "⏱️";
      if (pathLower.includes("/database/") || ext === "sql" || ext === "db") return "🗄️";
      if (pathLower.includes("/data/") || ["xlsx","xls","csv","json"].includes(ext)) return "🧮";
      if (pathLower.includes("/output/") || ext === "log") return "🧾";
      if (ext === "py") return "🐍";
      if (ext === "md") return "📘";
      if (["pbix","pbit"].includes(ext)) return "📊";
      if (["png","jpg","gif"].includes(ext)) return "🖼️";
      if (ext === "pdf") return "🧱";
      return "📄";
    }

    // Tokenization for trace mode
    const STOP = new Set(["the","and","or","of","to","a","an","in","on","for","with","from","by","v","v2","test","data","agent","collector","collectors","script","scripts","src","file","files","report","reports"]);
    function tokensFromNode(d) {
      const name = (d.data.name || "").toLowerCase();
      const desc = (d.data.description || "").toLowerCase();
      const base = (name + " " + desc).replace(/[^a-z0-9_\-\s]/g," ");
      const parts = base.split(/\s+|_|\-/g).map(s=>s.trim()).filter(Boolean);
      const toks = [];
      for (const p of parts) {
        if (p.length < 3) continue;
        if (STOP.has(p)) continue;
        toks.push(p);
      }
      // de-dup
      return Array.from(new Set(toks)).slice(0, 20);
    }

    function showToast(msg) {
      const el = document.getElementById("toast");
      el.innerHTML = msg;
      el.style.display = "block";
      clearTimeout(showToast._t);
      showToast._t = setTimeout(()=>{ el.style.display = "none"; }, 2400);
    }

    // ====== SVG / Layout ======
    const container = document.getElementById('tree-container');
    const svg = d3.select('#tree');
    const g = svg.append('g').attr('class','viewport');
    const laneG = svg.append('g').attr('class','lanes'); // for architect labels

    const zoom = d3.zoom()
      .scaleExtent([0.35, 2.5])
      .on('zoom', (event) => {
        g.attr('transform', event.transform);
        laneG.attr('transform', `translate(${event.transform.x}, ${event.transform.y}) scale(${event.transform.k})`);
      });

    svg.call(zoom).on("dblclick.zoom", null);

    // Layout settings
    const nodeWidth = 240;
    const nodeHeight = 28;
    let i = 0;
    let root;

    root = d3.hierarchy(data);
    root.x0 = 0;
    root.y0 = 0;

    // Stats
    const totalItems = root.descendants().length;
    document.getElementById("stats").textContent = `${totalItems} items • click to expand • zoom/pan enabled`;

    // Collapse all children initially except first level
    if (root.children) root.children.forEach(collapse);

    function collapse(d) {
      if (d.children) {
        d._children = d.children;
        d._children.forEach(collapse);
        d.children = null;
      }
    }

    function expand(d) {
      if (d._children) {
        d.children = d._children;
        d._children = null;
      }
    }

    // ====== Architect lanes ======
    const LANES = ["Config","Scripts","Agents","Orchestration","Scheduling","Database","Data","Output","Docs","Other"];
    const laneIndex = new Map(LANES.map((l, idx) => [l, idx]));
    const laneGap = 320; // horizontal distance between lanes

    function applyArchitectPositions(nodes) {
      // group by lane; keep within-lane y by depth and by stable index
      const laneCounts = new Map();
      nodes.forEach(d => {
        const p = buildPath(d).toLowerCase();
        const layer = getLayer(p);
        d._layer = layer;
        const idx = laneIndex.get(layer) ?? laneIndex.get("Other");
        d._lane = idx;

        const c = laneCounts.get(idx) || 0;
        laneCounts.set(idx, c+1);

        // vertical placement: x already computed by tree layout; keep it
        // horizontal placement: lane column + depth offset
        d.y = idx * laneGap + (d.depth * 70);
      });
    }

    function drawLanes(bounds) {
      laneG.selectAll("*").remove();
      if (!architectMode) return;

      const {minX, maxX} = bounds;
      const laneHeight = (maxX - minX) + 260;
      const yTop = minX - 130;

      const laneWidth = laneGap - 30;

      const laneData = LANES.map((name, idx) => ({name, idx}));

      const lanes = laneG.selectAll("g.lane")
        .data(laneData)
        .enter()
        .append("g")
        .attr("class","lane")
        .attr("transform", d => `translate(${d.idx * laneGap},${yTop})`);

      lanes.append("rect")
        .attr("class","lane-rect")
        .attr("x", 0)
        .attr("y", 0)
        .attr("width", laneWidth)
        .attr("height", laneHeight);

      lanes.append("text")
        .attr("class","lane-label")
        .attr("x", 14)
        .attr("y", 22)
        .text(d => d.name);
    }

    // ====== Highlight management ======
    function clearHighlights() {
      g.selectAll('.node').classed('highlighted', false).classed('dimmed', false);
      g.selectAll('.link').classed('highlighted', false).classed('dimmed', false);
    }

    function highlightSet(nodeIds, linkIds) {
      const idSet = new Set(nodeIds);
      g.selectAll('.node')
        .classed('highlighted', d => idSet.has(d.id))
        .classed('dimmed', d => !idSet.has(d.id));

      const lSet = new Set(linkIds);
      g.selectAll('.link')
        .classed('highlighted', d => lSet.has(d.target.id))
        .classed('dimmed', d => !lSet.has(d.target.id));
    }

    function buildLinkIdSet(nodesToKeep) {
      const keep = new Set(nodesToKeep.map(d=>d.id));
      const linkIds = [];
      nodesToKeep.forEach(d => {
        // highlight the path to root (links are keyed by target.id)
        let cur = d;
        while (cur && cur.parent) {
          if (keep.has(cur.id)) linkIds.push(cur.id);
          cur = cur.parent;
        }
      });
      return linkIds;
    }

    // ====== Trace mode scoring ======
    function computeTrace(dClicked) {
      const clickedPath = buildPath(dClicked).toLowerCase();
      const toks = tokensFromNode(dClicked);

      const nodes = root.descendants();
      const scored = [];

      for (const n of nodes) {
        const p = buildPath(n).toLowerCase();
        const name = (n.data.name || "").toLowerCase();
        const desc = (n.data.description || "").toLowerCase();

        let score = 0;

        // Always keep ancestry chain (context)
        if (dClicked.ancestors().includes(n)) score += 40;

        // Strong path affinity
        if (clickedPath.includes("/src/orchestrators/") && p.includes("/src/agents/")) score += 6;
        if (clickedPath.includes("/src/agents/") && p.includes("/database/")) score += 4;
        if (clickedPath.includes("/src/agents/") && p.includes("/data/")) score += 4;
        if (clickedPath.includes("/scripts/") && p.includes("/database/")) score += 3;
        if (clickedPath.includes("/src/scheduler/") && (p.includes("/src/agents/") || p.includes("/scripts/"))) score += 4;
        if (p.includes("/output/") && (clickedPath.includes("report") || clickedPath.includes("hb"))) score += 3;

        // Token matches (practical heuristic)
        for (const t of toks) {
          if (name.includes(t)) score += 6;
          if (p.includes(t)) score += 3;
          if (desc.includes(t)) score += 2;
        }

        // Boost key categories when the clicked item is an orchestrator/scheduler
        const nLayer = getLayer(p);
        if (clickedPath.includes("orchestrator") || clickedPath.includes("/src/orchestrators/")) {
          if (["Agents","Database","Data","Output","Scheduling"].includes(nLayer)) score += 2;
        }
        if (clickedPath.includes("scheduler") || clickedPath.includes("/src/scheduler/") || clickedPath.includes("overnight")) {
          if (["Agents","Scripts","Output"].includes(nLayer)) score += 2;
        }

        if (score > 0) scored.push({n, score});
      }

      scored.sort((a,b)=>b.score-a.score);

      // Keep top-N plus ensure ancestry
      const picked = [];
      const pickedIds = new Set();

      const addNode = (n) => {
        if (!pickedIds.has(n.id)) {
          pickedIds.add(n.id);
          picked.push(n);
        }
      };

      for (const s of scored.slice(0, 30)) addNode(s.n);
      // Ensure all ancestors of those nodes are included
      picked.slice().forEach(n => n.ancestors().forEach(addNode));

      const linkIds = buildLinkIdSet(picked);
      return {picked, linkIds, toks};
    }

    // ====== Tree update ======
    function update(source) {
      // Layout
      const treeLayout = d3.tree().nodeSize([nodeHeight, nodeWidth]);
      const treeData = treeLayout(root);

      const nodes = treeData.descendants();
      const links = treeData.links();

      // Normalize depth baseline
      nodes.forEach(d => {
        d.y = d.depth * 210;
      });

      // Apply architect positions if toggled
      if (architectMode) {
        applyArchitectPositions(nodes);
      }

      // Bounds
      let minX = Infinity, maxX = -Infinity, minY = Infinity, maxY = -Infinity;
      nodes.forEach(d => {
        if (d.x < minX) minX = d.x;
        if (d.x > maxX) maxX = d.x;
        if (d.y < minY) minY = d.y;
        if (d.y > maxY) maxY = d.y;
      });

      // Resize SVG (keep generous margins)
      const width = (maxY - minY) + 900;
      const height = (maxX - minX) + 400;
      svg.attr('width', width).attr('height', height);

      // Translate view to keep content visible; do NOT override zoom transform if user has already zoomed/panned
      // We'll only apply initial translate on first render (when no zoom transform has been applied).
      const t = d3.zoomTransform(svg.node());
      const isIdentity = (t.k === 1 && t.x === 0 && t.y === 0);
      if (isIdentity) {
        const initial = d3.zoomIdentity.translate(80 - minY, 120 - minX).scale(1);
        svg.call(zoom.transform, initial);
      }

      drawLanes({minX, maxX});

      // ===== Nodes =====
      const node = g.selectAll('g.node')
        .data(nodes, d => d.id || (d.id = ++i));

      const nodeEnter = node.enter().append('g')
        .attr('class', 'node')
        .attr('transform', d => `translate(${source.y0 || 0},${source.x0 || 0})`)
        .on('click', (event, d) => {
          const shift = event.shiftKey;

          // expand/collapse only when clicking folders OR when trace is off
          if (!traceMode && !shift) {
            if (d.children) {
              d._children = d.children;
              d.children = null;
            } else if (d._children) {
              d.children = d._children;
              d._children = null;
            }
            update(d);
          } else {
            // In trace mode, allow expand/collapse on folders with Alt
            if (event.altKey && isFolder(d)) {
              if (d.children) {
                d._children = d.children;
                d.children = null;
              } else if (d._children) {
                d.children = d._children;
                d._children = null;
              }
              update(d);
            }
          }

          showDetails(d);

          // Trace highlighting logic (Trace mode OR Shift-click)
          if (traceMode || shift) {
            const {picked, linkIds, toks} = computeTrace(d);
            highlightSet(picked.map(x=>x.id), linkIds);
            showToast(`<strong>Trace:</strong> highlighting ${picked.length} related items • tokens: <span style="color:#8b949e">${toks.slice(0,8).join(", ") || "—"}</span>`);
          } else {
            clearHighlights();
          }

          lastClicked = d;
        });

      // add per-node derived data (layer + role + pathLower)
      nodeEnter.each(function(d) {
        const p = buildPath(d).toLowerCase();
        d._pathLower = p;
        d._layer = getLayer(p);
      });

      // Circle
      nodeEnter.append('circle')
        .attr('r', 6)
        .attr('fill', d => (isFolder(d) ? '#0d1117' : getNodeColor(d)))
        .attr('stroke', d => getNodeColor(d))
        .attr('stroke-width', 2);

      // Icon
      nodeEnter.append('text')
        .attr('class','icon')
        .attr('dy', '.35em')
        .attr('x', 12)
        .text(d => getIcon(d, d._pathLower));

      // Label
      nodeEnter.append('text')
        .attr('class', d => (isFolder(d) ? 'label folder-name' : 'label'))
        .attr('dy', '.35em')
        .attr('x', 34)
        .text(d => truncate(d.data.name, 48));

      // Expand/collapse indicator
      nodeEnter.append('text')
        .attr('class','toggle-indicator')
        .attr('dy', '.35em')
        .attr('x', -12)
        .attr('text-anchor','middle')
        .attr('fill', '#8b949e')
        .attr('font-size','10px')
        .text(d => d._children ? '+' : (d.children ? '-' : ''));

      // Update + role classes
      const nodeUpdate = nodeEnter.merge(node);

      nodeUpdate
        .classed('new', d => !!d.data.isNew)
        .each(function(d) {
          // role classes
          const p = d._pathLower || buildPath(d).toLowerCase();
          d._layer = getLayer(p);
          const roleClass = getRoleClass(d._layer);
          const sel = d3.select(this);
          sel.classed('role-agents', roleClass === 'role-agents');
          sel.classed('role-orchestration', roleClass === 'role-orchestration');
          sel.classed('role-data', roleClass === 'role-data');
          sel.classed('role-output', roleClass === 'role-output');
          sel.classed('role-db', roleClass === 'role-db');
        });

      nodeUpdate.transition()
        .duration(320)
        .attr('transform', d => `translate(${d.y},${d.x})`);

      nodeUpdate.select('circle')
        .attr('fill', d => (isFolder(d) ? '#0d1117' : getNodeColor(d)))
        .attr('stroke', d => getNodeColor(d));

      nodeUpdate.select('.toggle-indicator')
        .text(d => d._children ? '+' : (d.children ? '-' : ''));

      // Exit
      node.exit().transition()
        .duration(280)
        .attr('transform', d => `translate(${source.y},${source.x})`)
        .remove();

      // ===== Links =====
      const link = g.selectAll('path.link')
        .data(links, d => d.target.id);

      const linkEnter = link.enter().insert('path', 'g')
        .attr('class','link')
        .attr('d', d => {
          const o = {x: source.x0 || 0, y: source.y0 || 0};
          return diagonal(o, o);
        });

      linkEnter.merge(link).transition()
        .duration(320)
        .attr('d', d => diagonal(d.source, d.target));

      link.exit().transition()
        .duration(280)
        .attr('d', d => {
          const o = {x: source.x, y: source.y};
          return diagonal(o, o);
        })
        .remove();

      // Store old positions
      nodes.forEach(d => {
        d.x0 = d.x;
        d.y0 = d.y;
      });
    }

    function diagonal(s, d) {
      return `M ${s.y} ${s.x}
              C ${(s.y + d.y) / 2} ${s.x},
                ${(s.y + d.y) / 2} ${d.x},
                ${d.y} ${d.x}`;
    }

    // ===== Details panel =====
    function showDetails(d) {
      const folder = isFolder(d);
      const ext = folder ? "Folder" : (extOf(d) || "File").toUpperCase();
      const color = getNodeColor(d);
      const path = buildPath(d);
      const layer = d._layer || getLayer(path.toLowerCase());
      const icon = getIcon(d, path.toLowerCase());

      let html = `
        <div class="detail-item">
          <div class="detail-label">Name</div>
          <div class="detail-value">${icon} ${d.data.name}</div>
        </div>
        <div class="detail-item">
          <div class="detail-label">Path</div>
          <div class="detail-value path">${path}</div>
        </div>
        <div class="detail-item">
          <div class="detail-label">Classification</div>
          <div class="badges">
            <span class="type-badge" style="background:${color};color:${folder ? '#fff' : '#000'}">${folder ? 'Folder' : ext}</span>
            ${d.data.isNew ? '<span class="type-badge new-badge">NEW/MODIFIED</span>' : ''}
            <span class="type-badge layer-badge">${layer}</span>
          </div>
        </div>
        <div class="detail-item">
          <div class="detail-label">Description</div>
          <div class="detail-value">${d.data.description || 'No description available'}</div>
        </div>
      `;

      if (folder) {
        const childCount = (d.children || d._children || []).length;
        html += `
          <div class="detail-item">
            <div class="detail-label">Contents</div>
            <div class="detail-value">${childCount} item${childCount !== 1 ? 's' : ''}</div>
          </div>
        `;
      }

      // Helpful hint when in trace mode
      if (traceMode) {
        html += `
          <div class="detail-item">
            <div class="detail-label">Trace Mode</div>
            <div class="detail-value" style="color:#8b949e;">
              Click to highlight related components. Alt+Click on folders expands/collapses while tracing.
            </div>
          </div>
        `;
      }

      document.getElementById('details-content').innerHTML = html;
    }

    // ===== Controls =====
    function expandAll() {
      root.descendants().forEach(d => {
        if (d._children) {
          d.children = d._children;
          d._children = null;
        }
      });
      update(root);
      showToast("<strong>Expanded:</strong> all nodes opened");
    }

    function collapseAll() {
      root.descendants().forEach(d => {
        if (d.children && d.depth > 0) {
          d._children = d.children;
          d.children = null;
        }
      });
      update(root);
      showToast("<strong>Collapsed:</strong> all nodes closed");
    }

    function resetView() {
      root.descendants().forEach(d => {
        if (d.depth === 0) {
          if (d._children) { d.children = d._children; d._children = null; }
        } else if (d.depth === 1) {
          if (d.children) { d._children = d.children; d.children = null; }
        }
      });
      clearHighlights();
      update(root);
      container.scrollTo(0,0);
      svg.call(zoom.transform, d3.zoomIdentity.translate(80, 120).scale(1));
      showToast("<strong>Reset:</strong> view + highlights cleared");
    }

    document.getElementById('expandBtn').addEventListener('click', expandAll);
    document.getElementById('collapseBtn').addEventListener('click', collapseAll);
    document.getElementById('resetBtn').addEventListener('click', resetView);

    // Trace toggle
    const traceChip = document.getElementById('traceChip');
    traceChip.addEventListener('click', () => {
      traceMode = !traceMode;
      traceChip.classList.toggle('active', traceMode);
      if (!traceMode) {
        clearHighlights();
        showToast("<strong>Trace Mode:</strong> off");
      } else {
        showToast("<strong>Trace Mode:</strong> on • click any node to reveal connections");
      }
    });

    // Architect toggle
    const architectChip = document.getElementById('architectChip');
    architectChip.addEventListener('click', () => {
      architectMode = !architectMode;
      architectChip.classList.toggle('active', architectMode);
      clearHighlights();
      update(root);
      showToast(architectMode
        ? "<strong>Architect Mode:</strong> lanes enabled (grouped by logical layer)"
        : "<strong>Architect Mode:</strong> filesystem layout restored");
    });

    // ===== Search =====
    let searchTimeout;
    document.getElementById('search').addEventListener('input', (e) => {
      clearTimeout(searchTimeout);
      const query = e.target.value.toLowerCase().trim();

      searchTimeout = setTimeout(() => {
        clearHighlights();
        if (!query) return;

        const matches = [];
        root.descendants().forEach(d => {
          const name = (d.data.name || '').toLowerCase();
          const desc = (d.data.description || '').toLowerCase();
          if (name.includes(query) || desc.includes(query)) {
            matches.push(d);
          }
        });

        if (matches.length === 0) {
          showToast(`<strong>Search:</strong> no matches for “${query}”`);
          return;
        }

        // Expand paths to matches
        matches.forEach(match => {
          let current = match.parent;
          while (current) {
            if (current._children) {
              current.children = current._children;
              current._children = null;
            }
            current = current.parent;
          }
        });

        update(root);

        // Highlight matches after re-render settles
        setTimeout(() => {
          const ids = new Set(matches.map(m => m.id));
          g.selectAll('.node')
            .classed('highlighted', d => ids.has(d.id))
            .classed('dimmed', d => !ids.has(d.id));

          const linkIds = buildLinkIdSet(matches);
          g.selectAll('.link')
            .classed('highlighted', d => linkIds.includes(d.target.id))
            .classed('dimmed', d => !linkIds.includes(d.target.id));

          // Scroll to first match (container scroll only; zoom remains)
          const first = matches[0];
          container.scrollTo({
            left: Math.max(0, first.y - 200),
            top: Math.max(0, first.x - container.clientHeight / 2 + 50),
            behavior: 'smooth'
          });

          showToast(`<strong>Search:</strong> ${matches.length} match${matches.length!==1?'es':''} for “${query}”`);
        }, 360);
      }, 260);
    });

    // Initial render
    update(root);
  </script>
</body>
</html>
